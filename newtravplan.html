<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    

    <title>New travel plan</title>

    <link rel="stylesheet" href="newtravplan.css">

    <script>
      var Info //JSONObjekt mit allen Userinfos nach der Skriptausf체hrung
      var by = document.cookie.split("=")[1] //Der eingeloggte Benutzer
      console.log(by)
      var month
      var days
      var country
      var city
      var reiseart
      var budget
      var flex
      //Die folgenden Daten kommen aus der Info Variable
      var alter
      var gender
      var langu

      function Zwischenablage(date1, date2){
        var Tage = (date2.getTime() - date1.getTime())/ (1000*3600*24)
        days = Tage
        month = date1.getFullYear()+"-"+date1.getMonth() //es wird nur der Abreisemonat gespeichert nicht der Endmonat
        console.log(Tage, month)
      }
      function suchen(){
        
        country = document.getElementById("country").value;
        city = document.getElementById("city").value;
        reiseart = document.getElementById("reiseart").value;
        budget = document.getElementById("budget").value;
        flex = document.getElementById("flexi").value;

        console.log(country,city,reiseart,budget, flex, by)
        
        GetUserDaten()
       
      }
      function GetUserDaten(){
        $.getJSON("https://webtechlecture.appspot.com/cloudstore/listobjects?owner=bjoernsreise2",function(response)
        {
          $.each(response,function(index,keys)
            {

              if(keys["key"] == by){
                Info = keys["jsonstring"]["info"]

                alter   = Info["Bday"]
                gender  = Info["Gender"]
                langu  = Info["Sprachen"]
                alert(alter, gender, langu)
                ReiseSpeichern()
                return false // Die Daten des Users wurden abgerufen
              }

                    
            });
          
          });
          
      }
      //체bergebene Variablen noch anlegen
      function ReiseSpeichern(){
        var aJSONString = {"Reiseziel":[country,city],"Zeit":[month, days, flex],"Alter":alter,"Reiseart":reiseart,"Budget":budget,"Sprachen":langu,"Gender":gender,"By":by}
        $.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=bjoernsreise5/Reise"+
        "&jsonstring="+[encodeURIComponent(JSON.stringify(aJSONString))],
					  function(response)
					  {
						console.log(response);
            console.log(response["message"].split("key=")[1])
            
            if (response["status"]=="ok"){
              alert('Dein Travelbuddy wird dich schon bald anschreiben '+ by +'!');
              ErstellteReiseSpeichern(response["message"].split("key=")[1],by);
            }
						});
      }

      function ErstellteReiseSpeichern(aKey,user){

        $.getJSON("https://webtechlecture.appspot.com/cloudstore/listobjects?owner=bjoernsreise2",function(response)
        {
          
          $.each(response,function(index,keys)
            {

              if(keys["key"] == user){
                var aJSONString = keys["jsonstring"]

                if (aJSONString["Reisen"]){
                  aJSONString["Reisen"].push(aKey)
                }
                else{
                  aJSONString["Reisen"] = [aKey]
                }
                
                $.getJSON("https://webtechlecture.appspot.com/cloudstore/add?owner=bjoernsreise2"+"&key="+user+
                          "&jsonstring="+[encodeURIComponent(JSON.stringify(aJSONString))],
                          function(response)
                          {console.log(response)});
                return false // an dieser Stelle ist die Reise gespeichert und die ID beim User selbst abrufbar
              }

                    
            });
          
          }).done( function(){
            alert("Vielleicht findest du ja auch schon passende Angebote")//sp채ter rausnehmen
            window.open("searchresults.html","_self")
            });

      }
    </script>

</head>

<body>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-logo" href="#"><img src="pics/logo.jpg"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto nav-fill w-100" style="font-size: large;">
            <li class="nav-item"><a class="nav-link" href="Start.html">Start</a></li>
            <li class="nav-item"><a class="nav-link" href="nonexistent.html">About</a></li>
            <li class="nav-item aktiv"><a class="nav-link" href="Findbefound.html">Find and be found</a></li>
            <li class="nav-item"><a class="nav-link" href="nonexistent.html">Community</a></li>
            <li class="nav-item"><a class="nav-link" href="nonexistent.html">Help</a></li>
            <li class="nav-item konto"><a href="login.html"><img src="pics/Avatar.png" class="loginpic"></a></li>
          </ul>
          
        </div>
    </nav>

  <div class="container">
    <h1>What's your plan?</h1>
    <p>Select the dates and destination for your planned trip. If applicable, let others know whether your flexible in outward and
      return journey, otherwise just enter 0. In case you don't know yet which city you are going to visit, just fill in the country
      and leave the field blank. To make sure the vacation turn out as imagined, share the budget you are willing to spend in US-Dollar and your 
    preffered way of traveling.</p>
    
      <div class="col-lg-4 ">
        <div class="calendar calendar-first" id="calendar_first">
          <div class="calendar_header">
              <button class="switch-month switch-left"> <i class="fa fa-chevron-left"></i></button>
                <h2></h2>
              <button class="switch-month switch-right"> <i class="fa fa-chevron-right"></i></button>
          </div>
          <div class="calendar_weekdays"></div>
          <div class="calendar_content"></div>
        </div>
      </div>


      <div class="col-lg-8 "style="margin-top: 20px;">
        <div class="row">
          <div class="col-lg-4 col-md-8 col-sm-12">
            <label for="daterange">From - Until</label>
            <input type="text" name="daterange" class="form-control" value="01/01/2018 - 01/15/2018" />
          </div>
          <div class="col-lg-4 col-md-4 col-sm-12">
            <label for="flexi">Flexibility</label>
            <input type="number" id="flexi" class="form-control" placeholder="Number of days">
          </div>
        </div>

        <div class="row">
          <div class="col-lg-4 pl-3 pr-3" autocomplete="off">
            <div class="autocomplete">
              <input id="country" type="text" class="form-control" name="destination" placeholder="Choose country">
            </div>
          </div>
          <div class="col-lg-4 pl-3 pr-3">
            <input type="text" id="city" class="form-control" placeholder="City">
          </div>
        </div>

        <div class="row">
          <div class="col-lg-4 pl-3 pr-3">
            <select name="budget" id="budget" class="form-control dropdwn">
                <option value="" disabled selected hidden>Budget per day (in USD)</option>
                <option value="preisstufe1">0 - 50 $</option>
                <option value="preisstufe2"> 51 - 100 $</option>
                <option value="preisstufe3">101 - 150 $</option>
                <option value="preisstufe4">> 150 $</option>
            </select>
          </div>

          <div class="col-lg-4 pl-3 pr-3">
            <select name="reiseart" id="reiseart" class="form-control dropdwn">
                <option value="" disabled selected hidden>Your way of travelling</option>
                <option value="backpack">Backpacking</option>
                <option value="allinclusive">All inclusive</option>
                <option value="roadtrip">Roadtrip</option>
                <option value="rest">NOCH WAS?</option>
            </select>    
          </div>

        </div>
        <div class="d-flex justify-content-center">
          <button type="button" class="btn btn-primary btn-sm suchen" onClick="suchen()"><a style="color: white;">Share my itinerary</a></button>
        </div>

      </div>


    </div>

    
<script>
  $(function() {
    $('input[name="daterange"]').daterangepicker({
      opens: 'left',
      alwaysShowCalendars: true,
      "startDate": "01/28/2020",
      "endDate": "02/03/2020"
        },
    function(start, end, label) {
      console.log(start.format('MM-DD-YYYY') + end.format(' MM-DD-YYYY'));
      //Erzeugt Datetime-Objekte
      var date1 = new Date(start.format('MM-DD-YYYY'))
      var date2 = new Date(end.format(' MM-DD-YYYY'))

      Zwischenablage(date1, date2)
    });
  });
</script>
    

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!--<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    
    <script>
    $('input[name="dates"]').daterangepicker();
    </script>
    
    <script> //AUTOCOMPLETE L채nder
      function autocompleteland(inp, arr) {
        var currentFocus;
        inp.addEventListener("input", function(e) {
            var a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (i = 0; i < arr.length; i++) {
              if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                b = document.createElement("DIV");
                b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                b.innerHTML += arr[i].substr(val.length);
                b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                b.addEventListener("click", function(e) {
                    inp.value = this.getElementsByTagName("input")[0].value;
                    closeAllLists();
                });
                a.appendChild(b);
              }
            }
        });
        inp.addEventListener("keydown", function(e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
              currentFocus++;
              addActive(x);
            } else if (e.keyCode == 38) { //up
              currentFocus--;
              addActive(x);
            } else if (e.keyCode == 13) {
              e.preventDefault();
              if (currentFocus > -1) {
                if (x) x[currentFocus].click();
              }
            }
        });
        function addActive(x) {
          /*a function to classify an item as "active":*/
          if (!x) return false;
          /*start by removing the "active" class on all items:*/
          removeActive(x);
          if (currentFocus >= x.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = (x.length - 1);
          x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) {
          for (var i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
          }
        }
        function closeAllLists(elmnt) {
          var x = document.getElementsByClassName("autocomplete-items");
          for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != inp) {
              x[i].parentNode.removeChild(x[i]);
            }
          }
        }
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
      }
      
      var countries = ["Afghanistan","Albania","Algeria","Andorra","Angola","Anguilla","Antigua & Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia","Bosnia & Herzegovina","Botswana","Brazil","British Virgin Islands","Brunei","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada","Cape Verde","Cayman Islands","Central Arfrican Republic","Chad","Chile","China","Colombia","Congo","Cook Islands","Costa Rica","Cote D Ivoire","Croatia","Cuba","Curacao","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Ethiopia","Falkland Islands","Faroe Islands","Fiji","Finland","France","French Polynesia","French West Indies","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guam","Guatemala","Guernsey","Guinea","Guinea Bissau","Guyana","Haiti","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Kosovo","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Macau","Macedonia","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Montserrat","Morocco","Mozambique","Myanmar","Namibia","Nauro","Nepal","Netherlands","Netherlands Antilles","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","North Korea","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Puerto Rico","Qatar","Reunion","Romania","Russia","Rwanda","Saint Pierre & Miquelon","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","St Kitts & Nevis","St Lucia","St Vincent","Sudan","Suriname","Swaziland","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor L'Este","Togo","Tonga","Trinidad & Tobago","Tunisia","Turkey","Turkmenistan","Turks & Caicos","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States of America","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Virgin Islands (US)","Yemen","Zambia","Zimbabwe"];
      
      autocompleteland(document.getElementById("country"), countries);
    </script>

<script>
    $(document).ready(function () {
      function c(passed_month, passed_year, calNum) {
          var calendar = calNum == 0 ? calendars.cal1 : calendars.cal2;
          makeWeek(calendar.weekline);
          calendar.datesBody.empty();
          var calMonthArray = makeMonthArray(passed_month, passed_year);
          var r = 0;
          var u = false;
          while (!u) {
              if (daysArray[r] == calMonthArray[0].weekday) {
                  u = true
              } else {
                  calendar.datesBody.append('<div class="blank"></div>');
                  r++;
              }
          }
          for (var cell = 0; cell < 42 - r; cell++) { // 42 date-cells in calendar
              if (cell >= calMonthArray.length) {
                  calendar.datesBody.append('<div class="blank"></div>');
              } else {
                  var shownDate = calMonthArray[cell].day;
                  var iter_date = new Date(passed_year, passed_month, shownDate);
                  if (
                  (
                  (shownDate != today.getDate() && passed_month == today.getMonth()) || passed_month != today.getMonth()) && iter_date < today) {
                      var m = '<div class="past-date">';
                  } else {
                      var m = checkToday(iter_date) ? '<div class="today">' : "<div>";
                  }
                  calendar.datesBody.append(m + shownDate + "</div>");
              }
          }

          var color = "#444444";
          calendar.calHeader.find("h2").text(i[passed_month] + " " + passed_year);
          calendar.weekline.find("div").css("color", color);
          calendar.datesBody.find(".today").css("color", "#87b633");

          // find elements (dates) to be clicked on each time
          // the calendar is generated
          var clicked = false;
          selectDates(selected);

          clickedElement = calendar.datesBody.find('div');
          clickedElement.on("click", function () {
              clicked = $(this);
              var whichCalendar = calendar.name;

              if (firstClick && secondClick) {
                  thirdClicked = getClickedInfo(clicked, calendar);
                  var firstClickDateObj = new Date(firstClicked.year,
                  firstClicked.month,
                  firstClicked.date);
                  var secondClickDateObj = new Date(secondClicked.year,
                  secondClicked.month,
                  secondClicked.date);
                  var thirdClickDateObj = new Date(thirdClicked.year,
                  thirdClicked.month,
                  thirdClicked.date);
                  if (secondClickDateObj > thirdClickDateObj && thirdClickDateObj > firstClickDateObj) {
                      secondClicked = thirdClicked;
                      // then choose dates again from the start :)
                      bothCals.find(".calendar_content").find("div").each(function () {
                          $(this).removeClass("selected");
                      });
                      selected = {};
                      selected[firstClicked.year] = {};
                      selected[firstClicked.year][firstClicked.month] = [firstClicked.date];
                      selected = addChosenDates(firstClicked, secondClicked, selected);
                  } else { // reset clicks
                      selected = {};
                      firstClicked = [];
                      secondClicked = [];
                      firstClick = false;
                      secondClick = false;
                      bothCals.find(".calendar_content").find("div").each(function () {
                          $(this).removeClass("selected");
                      });
                  }
              }
              if (!firstClick) {
                  firstClick = true;
                  firstClicked = getClickedInfo(clicked, calendar);
                  selected[firstClicked.year] = {};
                  selected[firstClicked.year][firstClicked.month] = [firstClicked.date];
              } else {
                  secondClick = true;
                  secondClicked = getClickedInfo(clicked, calendar);

                  // what if second clicked date is before the first clicked?
                  var firstClickDateObj = new Date(firstClicked.year,
                  firstClicked.month,
                  firstClicked.date);
                  var secondClickDateObj = new Date(secondClicked.year,
                  secondClicked.month,
                  secondClicked.date);

                  if (firstClickDateObj > secondClickDateObj) {

                      var cachedClickedInfo = secondClicked;
                      secondClicked = firstClicked;
                      firstClicked = cachedClickedInfo;
                      selected = {};
                      selected[firstClicked.year] = {};
                      selected[firstClicked.year][firstClicked.month] = [firstClicked.date];

                  } else if (firstClickDateObj.getTime() == secondClickDateObj.getTime()) {
                      selected = {};
                      firstClicked = [];
                      secondClicked = [];
                      firstClick = false;
                      secondClick = false;
                      $(this).removeClass("selected");
                  }


                  // add between dates to [selected]
                  selected = addChosenDates(firstClicked, secondClicked, selected);
              }
              selectDates(selected);
          });

      }

      function selectDates(selected) {
          if (!$.isEmptyObject(selected)) {
              var dateElements1 = datesBody1.find('div');
              var dateElements2 = datesBody2.find('div');

              function highlightDates(passed_year, passed_month, dateElements) {
                  if (passed_year in selected && passed_month in selected[passed_year]) {
                      var daysToCompare = selected[passed_year][passed_month];
                      for (var d in daysToCompare) {
                          dateElements.each(function (index) {
                              if (parseInt($(this).text()) == daysToCompare[d]) {
                                  $(this).addClass('selected');
                              }
                          });
                      }

                  }
              }

              highlightDates(year, month, dateElements1);
              highlightDates(nextYear, nextMonth, dateElements2);
          }
      }

      function makeMonthArray(passed_month, passed_year) { // creates Array specifying dates and weekdays
          var e = [];
          for (var r = 1; r < getDaysInMonth(passed_year, passed_month) + 1; r++) {
              e.push({
                  day: r,
                  // Later refactor -- weekday needed only for first week
                  weekday: daysArray[getWeekdayNum(passed_year, passed_month, r)]
              });
          }
          return e;
      }

      function makeWeek(week) {
          week.empty();
          for (var e = 0; e < 7; e++) {
              week.append("<div>" + daysArray[e].substring(0, 3) + "</div>")
          }
      }

      function getDaysInMonth(currentYear, currentMon) {
          return (new Date(currentYear, currentMon + 1, 0)).getDate();
      }

      function getWeekdayNum(e, t, n) {
          return (new Date(e, t, n)).getDay();
      }

      function checkToday(e) {
          var todayDate = today.getFullYear() + '/' + (today.getMonth() + 1) + '/' + today.getDate();
          var checkingDate = e.getFullYear() + '/' + (e.getMonth() + 1) + '/' + e.getDate();
          return todayDate == checkingDate;

      }

      function getAdjacentMonth(curr_month, curr_year, direction) {
          var theNextMonth;
          var theNextYear;
          if (direction == "next") {
              theNextMonth = (curr_month + 1) % 12;
              theNextYear = (curr_month == 11) ? curr_year + 1 : curr_year;
          } else {
              theNextMonth = (curr_month == 0) ? 11 : curr_month - 1;
              theNextYear = (curr_month == 0) ? curr_year - 1 : curr_year;
          }
          return [theNextMonth, theNextYear];
      }

      function b() {
          today = new Date;
          year = today.getFullYear();
          month = today.getMonth();
          var nextDates = getAdjacentMonth(month, year, "next");
          nextMonth = nextDates[0];
          nextYear = nextDates[1];
      }

      var e = 480;

      var today;
      var year,
      month,
      nextMonth,
      nextYear;

      var r = [];
      var i = [
          "JANUARY",
          "FEBRUARY",
          "MARCH",
          "APRIL",
          "MAY",
          "JUNE",
          "JULY",
          "AUGUST",
          "SEPTEMBER",
          "OCTOBER",
          "NOVEMBER",
          "DECEMBER"];
      var daysArray = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday"];

      var cal1 = $("#calendar_first");
      var calHeader1 = cal1.find(".calendar_header");
      var weekline1 = cal1.find(".calendar_weekdays");
      var datesBody1 = cal1.find(".calendar_content");

      var cal2 = $("#calendar_second");
      var calHeader2 = cal2.find(".calendar_header");
      var weekline2 = cal2.find(".calendar_weekdays");
      var datesBody2 = cal2.find(".calendar_content");

      var bothCals = $(".calendar");

      var switchButton = bothCals.find(".calendar_header").find('.switch-month');

      var calendars = {
          "cal1": {
              "name": "first",
                  "calHeader": calHeader1,
                  "weekline": weekline1,
                  "datesBody": datesBody1
          },
              "cal2": {
              "name": "second",
                  "calHeader": calHeader2,
                  "weekline": weekline2,
                  "datesBody": datesBody2
          }
      }


      var clickedElement;
      var firstClicked,
      secondClicked,
      thirdClicked;
      var firstClick = false;
      var secondClick = false;
      var selected = {};

      b();
      c(month, year, 0);
      c(nextMonth, nextYear, 1);
      switchButton.on("click", function () {
          var clicked = $(this);
          var generateCalendars = function (e) {
              var nextDatesFirst = getAdjacentMonth(month, year, e);
              var nextDatesSecond = getAdjacentMonth(nextMonth, nextYear, e);
              month = nextDatesFirst[0];
              year = nextDatesFirst[1];
              nextMonth = nextDatesSecond[0];
              nextYear = nextDatesSecond[1];

              c(month, year, 0);
              c(nextMonth, nextYear, 1);
          };
          if (clicked.attr("class").indexOf("left") != -1) {
              generateCalendars("previous");
          } else {
              generateCalendars("next");
          }
          clickedElement = bothCals.find(".calendar_content").find("div");
      });


      //  Click picking stuff
      function getClickedInfo(element, calendar) {
          var clickedInfo = {};
          var clickedCalendar,
          clickedMonth,
          clickedYear;
          clickedCalendar = calendar.name;
          clickedMonth = clickedCalendar == "first" ? month : nextMonth;
          clickedYear = clickedCalendar == "first" ? year : nextYear;
          clickedInfo = {
              "calNum": clickedCalendar,
                  "date": parseInt(element.text()),
                  "month": clickedMonth,
                  "year": clickedYear
          }
          return clickedInfo;
      }


      // Finding between dates MADNESS. Needs refactoring and smartening up :)
      function addChosenDates(firstClicked, secondClicked, selected) {
          if (secondClicked.date > firstClicked.date || secondClicked.month > firstClicked.month || secondClicked.year > firstClicked.year) {

              var added_year = secondClicked.year;
              var added_month = secondClicked.month;
              var added_date = secondClicked.date;

              if (added_year > firstClicked.year) {
                  // first add all dates from all months of Second-Clicked-Year
                  selected[added_year] = {};
                  selected[added_year][added_month] = [];
                  for (var i = 1;
                  i <= secondClicked.date;
                  i++) {
                      selected[added_year][added_month].push(i);
                  }

                  added_month = added_month - 1;
                  while (added_month >= 0) {
                      selected[added_year][added_month] = [];
                      for (var i = 1;
                      i <= getDaysInMonth(added_year, added_month);
                      i++) {
                          selected[added_year][added_month].push(i);
                      }
                      added_month = added_month - 1;
                  }

                  added_year = added_year - 1;
                  added_month = 11; // reset month to Dec because we decreased year
                  added_date = getDaysInMonth(added_year, added_month); // reset date as well

                  // Now add all dates from all months of inbetween years
                  while (added_year > firstClicked.year) {
                      selected[added_year] = {};
                      for (var i = 0; i < 12; i++) {
                          selected[added_year][i] = [];
                          for (var d = 1; d <= getDaysInMonth(added_year, i); d++) {
                              selected[added_year][i].push(d);
                          }
                      }
                      added_year = added_year - 1;
                  }
              }

              if (added_month > firstClicked.month) {
                  if (firstClicked.year == secondClicked.year) {
                      selected[added_year][added_month] = [];
                      for (var i = 1;
                      i <= secondClicked.date;
                      i++) {
                          selected[added_year][added_month].push(i);
                      }
                      added_month = added_month - 1;
                  }
                  while (added_month > firstClicked.month) {
                      selected[added_year][added_month] = [];
                      for (var i = 1;
                      i <= getDaysInMonth(added_year, added_month);
                      i++) {
                          selected[added_year][added_month].push(i);
                      }
                      added_month = added_month - 1;
                  }
                  added_date = getDaysInMonth(added_year, added_month);
              }

              for (var i = firstClicked.date + 1;
              i <= added_date;
              i++) {
                  selected[added_year][added_month].push(i);
              }
          }
          return selected;
      }
    });
  </script>
</body>
</html>